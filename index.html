<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Trading Journal Calendar</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { background:#121212; color:#e0e0e0; font-family: Arial,sans-serif; padding:10px; }
  h1, h2 { text-align:center; }
  table { width:100%; border-collapse:collapse; margin-bottom:20px; table-layout:fixed; }
  th, td { border:1px solid #444; padding:4px; height:100px; position:relative; cursor:pointer; vertical-align:top; }
  th { background:#222; }
  .day-number { position:absolute; top:2px; right:2px; font-size:0.7em; opacity:0.8; }
  .profit-loss { position:absolute; bottom:2px; left:2px; font-size:0.7em; }
  td.green { background:rgba(0,200,0,0.3); }
  td.red { background:rgba(200,0,0,0.3); }
  td.white { background:rgba(255,255,255,0.05); }
  #notesPreview { padding:10px; border:1px solid #555; min-height:150px; background:#222; margin-bottom:20px; }
  .image-preview { max-width:80px; max-height:80px; cursor:pointer; margin:2px; }
  .image-zoom { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:1000; }
  .image-zoom img { max-width:90%; max-height:90%; }
  #modal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#222; padding:20px; border:1px solid #555; z-index:1001; width:320px; max-height:90vh; overflow-y:auto; }
  label { display:block; margin:8px 0 4px; }
  input, textarea { width:100%; padding:4px; background:#333; color:#fff; border:1px solid #555; }
  button { background:#444; color:#fff; border:none; padding:6px 10px; cursor:pointer; margin:5px 0; }
  @media(max-width:768px){
    table { display:block; overflow-x:auto; white-space:nowrap; }
    th, td { min-width:80px; padding:2px; }
    #modal { width:90vw; padding:10px; }
  }
</style>
</head>
<body>

<h1>Trading Journal Calendar</h1>
<div style="text-align:center; margin:10px;">
  <button onclick="prevMonth()">&#8592;</button>
  <span id="month-label" style="margin:0 10px; font-size:1.2em;"></span>
  <button onclick="nextMonth()">&#8594;</button>
</div>

<table id="calendar"></table>

<h2>Day Details</h2>
<div id="notesPreview"><em>Hover or click a day to see its details.</em></div>

<h2>Win Rate This Month</h2>
<canvas id="winrate-chart" width="200" height="200"></canvas>

<div id="image-zoom" class="image-zoom" onclick="this.style.display='none'">
  <img id="zoom-img" />
</div>

<div id="modal" style="display:none;">
  <h3>Trade Details for <span id="modal-date"></span></h3>
  <label>Profit/Loss ($): <input id="profitLossInput" type="number" step="0.01"></label>
  <label>Notes:<textarea id="notesInput"></textarea></label>
  <label>Weekly TF:<input id="weeklyInput" type="file" accept="image/*"></label>
  <label>Daily TF:<input id="dailyInput" type="file" accept="image/*"></label>
  <label>4hr TF:<input id="fourhrInput" type="file" accept="image/*"></label>
  <label>1hr TF:<input id="onehrInput" type="file" accept="image/*"></label>
  <label>15m TF:<input id="fifteenmInput" type="file" accept="image/*"></label>
  <label>3m TF:<input id="threeminInput" type="file" accept="image/*"></label>
  <label>1m TF:<input id="oneminInput" type="file" accept="image/*"></label>
  <button onclick="saveTrade()">Save</button>
  <button onclick="closeModal()">Close</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA2WEvj1pqPkmgEU5a2yuzgPNCShlviqRI",
    authDomain: "trading-journal-raysuuu.firebaseapp.com",
    projectId: "trading-journal-raysuuu",
    storageBucket: "trading-journal-raysuuu.firebasestorage.app",
    messagingSenderId: "205166502407",
    appId: "1:205166502407:web:19b0217e8b063ab14440a2",
    measurementId: "G-5BCH0D9CZQ"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let trades = {};
  let currentYear = new Date().getFullYear();
  let currentMonth = new Date().getMonth();
  let selectedDate = null;
  let winRateChart = null;

  function buildCalendar(year, month) {
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();
    let table = '<tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>';
    let dayCount = 1;
    for (let r=0; r<6; r++){
      table += '<tr>';
      for (let c=0; c<7; c++){
        if(r===0 && c<firstDay || dayCount>daysInMonth) {
          table += '<td class="white"></td>';
        } else {
          table += `<td id="date-${dayCount}" class="white" onmouseenter="showDetails(${dayCount})" onclick="openModal(${dayCount})">
            <div class="day-number">${dayCount}</div>
            <div class="profit-loss"></div>
          </td>`;
          dayCount++;
        }
      }
      table += '</tr>';
    }
    document.getElementById('calendar').innerHTML = table;
    document.getElementById('month-label').textContent = new Date(year,month).toLocaleString('default', {month:'long', year:'numeric'});
  }

  window.colorCell = (day, profitLoss) => {
    const cell = document.getElementById('date-'+day);
    if (!cell) return;
    cell.className = profitLoss>0?'green': profitLoss<0?'red':'white';
    cell.querySelector('.profit-loss').textContent = profitLoss;
  }

  window.showDetails = (day) => {
    const preview = document.getElementById('notesPreview');
    preview.innerHTML = '';
    if (trades[day]) {
      const data = trades[day];
      let html = '<strong>Profit/Loss:</strong> ' + data.profitLoss + '<br><strong>Notes:</strong> ' + (data.notes||'No details') + '<br>';
      ['weekly','daily','fourhr','onehr','fifteenm','threemin','onemin'].forEach(tf => {
        if (data.screenshots && data.screenshots[tf]) {
          html += `<img src="${data.screenshots[tf]}" class="image-preview" onclick="zoomImage('${data.screenshots[tf]}')">`;
        }
      });
      preview.innerHTML = html;
    } else {
      preview.innerHTML = '<em>No trade this day.</em>';
    }
  }

  window.zoomImage = (src) => {
    document.getElementById('zoom-img').src = src;
    document.getElementById('image-zoom').style.display='flex';
  }

  window.openModal = (day) => {
    selectedDate = day;
    document.getElementById('modal-date').textContent = day;
    document.getElementById('profitLossInput').value = trades[day]?.profitLoss||'';
    document.getElementById('notesInput').value = trades[day]?.notes||'';
    document.getElementById('modal').style.display='block';
  }

  window.closeModal = () => document.getElementById('modal').style.display='none';

  async function toBase64(file) {
    return new Promise(res => {
      const reader = new FileReader();
      reader.onload = e => res(e.target.result); reader.readAsDataURL(file);
    });
  }

  window.saveTrade = async () => {
    const profitLoss = parseFloat(document.getElementById('profitLossInput').value) || 0;
    const notes = document.getElementById('notesInput').value;
    const screenshots = {};
    for (let tf of ['weekly','daily','fourhr','onehr','fifteenm','threemin','onemin']) {
      const file = document.getElementById(tf+'Input').files[0];
      if (file) screenshots[tf] = await toBase64(file); else if (trades[selectedDate]?.screenshots?.[tf]) screenshots[tf] = trades[selectedDate].screenshots[tf];
    }
    trades[selectedDate] = { profitLoss, notes, screenshots };
    colorCell(selectedDate, profitLoss);
    await setDoc(doc(db,"trades",String(selectedDate)), trades[selectedDate]);
    closeModal();
    renderWinrateChart();
  }

  window.prevMonth = () => { currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} buildCalendar(currentYear,currentMonth); loadData(); }
  window.nextMonth = () => { currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} buildCalendar(currentYear,currentMonth); loadData(); }

  async function loadData() {
    trades = {};
    const snapshot = await getDocs(collection(db,"trades"));
    snapshot.docs.forEach(docSnap=>{
      trades[docSnap.id]=docSnap.data();
      colorCell(docSnap.id, docSnap.data().profitLoss);
    });
    renderWinrateChart();
  }

  function renderWinrateChart() {
    let wins=0, losses=0, noTrades=0;
    for(let d=1; d<=31; d++){
      if(!document.getElementById('date-'+d)) continue;
      if(!trades[d]) { noTrades++; continue; }
      if(trades[d].profitLoss>0) wins++;
      else if(trades[d].profitLoss<0) losses++;
      else noTrades++;
    }
    if(winRateChart) winRateChart.destroy();
    winRateChart = new Chart(document.getElementById('winrate-chart').getContext('2d'), {
      type:'pie',
      data:{ labels:['Wins','Losses','No trade'], datasets:[{ data:[wins,losses,noTrades], backgroundColor:['green','red','gray']} ] }
    });
  }

  // Paste listener
  document.getElementById('modal').addEventListener('paste', async e => {
    const files = Array.from(e.clipboardData.items).filter(it=>it.kind==='file'&&it.type.startsWith('image/')).map(it=>it.getAsFile());
    if (files.length) {
      const inputs=['weeklyInput','dailyInput','fourhrInput','onehrInput','fifteenmInput','threeminInput','oneminInput'];
      for(let input of inputs){
        if(document.getElementById(input).files.length===0){
          const dt=new DataTransfer(); dt.items.add(files[0]);
          document.getElementById(input).files=dt.files;
          alert(`Image pasted into ${input}.`);
          break;
        }
      }
    }
  });

  buildCalendar(currentYear,currentMonth); loadData();
</script>
</body>
</html>
